<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>backchan.nl &mdash; thin</title>

	<script src="/static/js/lib/jquery-1.6.2.min.js" type="text/javascript"></script>
	<script src="/static/js/lib/underscore-min.js" type="text/javascript"></script>
	<script src="/static/js/lib/backbone-min.js" type="text/javascript"></script>
	
	<script src="/socket.io/socket.io.js"></script>
	
	<script type="text/javascript" charset="utf-8">
	
		/* STARTUP & SETUP */
		var socket = io.connect("http://<% server %>:<%= port %>");
		var hotPostsList;
		var newPostsList;
		var allPostsList;
	
		$(document).ready(function() {
			console.log("Document is ready!");

			if("name" in localStorage && "affiliation" in localStorage) {
				console.log("auto-logging in");
				socket.emit("identify", {
					"name":localStorage["name"],
					"affiliation":localStorage["affiliation"]});
				$("#identify").hide();
			} else {
				$("#dashboard").hide();
			}

			
			
			$("#identify form").submit(function(event) {
				// Send a message to the server.
				
				var name = $("#name").val();
				var affiliation = $("#affiliation").val();
				
				socket.emit("identify", {
					"name":name,
					"affiliation":affiliation});
					
					localStorage["name"] = name;
					localStorage["affiliation"] = affiliation;
					
				event.preventDefault();
			});
			
			$("#toggle-post").click(togglePostContainer);
			$("#show-posts").click(toggleAllPosts);
			
			$("#submit-post").click(function() {
				socket.emit("post", {"text":$("#post-text").val()});
				$("#post-text").val("");
				togglePostContainer();
			});
			
			// Do some testing of the backbone situation to see if the pieces
			// are all working correctly.
			newPostsList = new Backchannl.NewPostList();
			newPostsListView = new Backchannl.NewPostListView({collection: newPostsList});
			
			hotPostsList = new Backchannl.PostList();
			hotPostsListView = new Backchannl.HotPostListView({collection: hotPostsList});
			
			allPostsList = new Backchannl.PostList();
			allPostsListView = new Backchannl.PostListView({collection:allPostsList});

			$("#dashboard").prepend(newPostsListView.render().el);
			$("#dashboard").prepend(hotPostsListView.render().el);
			$("#dashboard").append(allPostsListView.render().el);
		});
		
		socket.on('connect', function(data) {
			console.log("Connected to server.");
		});
		
		socket.on('identify', function(data) {
			$("#identity").text(data["name"] + " / " + data["affiliation"]);
			$("#presence").text("1 person connected");
			
			
			// When the server ACKS our identify operation, hide that pane
			// and show the main one.
			$("#identify").hide();
			$("#dashboard").show();
			
		});
		
		socket.on('post.new', function(data) {
			
			// Construct a new post model object out of the data.
			var newPostModel = new Backchannl.Post(data);
			
			console.log(newPostModel);
			
			newPostsList.add(newPostModel);
			
			allPostsList.add(newPostModel);
		});
		
		function togglePostContainer() {
			// Decide what our current state is.
			var postContainerEl = $("#post-container");

			if(parseInt(postContainerEl.css("top")) < 0) {
				// Animate to expose it.
				postContainerEl.animate({top:0});
			} else {
				// Animate to hide it.
				postContainerEl.animate({top:-131});
			}
		}
		
		function toggleAllPosts() {
			var allPostsEl = $("#all");

			if(parseInt(allPostsEl.css("bottom")) > 200) {
				// Animate to expose it.
				allPostsEl.animate({bottom:-135});
			} else {
				// Animate to hide it.
				allPostsEl.animate({bottom:306});
			}
		}
		
	</script>
	
	<link rel="stylesheet" href="/static/css/base.css" type="text/css" media="screen"  charset="utf-8">
	
</head>
<body id="index" onload="">
<div id="container">

<div id="identify">
	<h1>Welcome to backchan.nl!</h1>
	<form method="get" accept-charset="utf-8">
	<table border="0">
		<tr><td>Name</td><td><input type="text" name="name" value="" id="name"></tr>
		<tr><td>Affiliation</td><td><input type="text" name="affiliation" value="" id="affiliation"></td></tr>
		<tr><td></td><td><input type="submit" name="set_identity" value="login" id="set_identity"<></td></tr>
	</table>
	</form>
</div>


<div id="dashboard">

<!-- The hot and new views get pushed in here automatically on startup. -->

<br class="clear">
<div id="footer">
<div id="identity">
</div>

<div id="show-posts">
show all posts
</div>

<div id="presence">
</div>
</div>
<br class="clear">
</div>


</div>

<div id="post-container">
<div id="post">
	<h1>Submit a post</h1>
	<textarea id="post-text">
	</textarea>
	<input type="button" name="post" value="post" id="submit-post">
</div>
<div id="toggle-post">
post a thought
</div>
</div>


<script src="/static/js/backchannl-backbone.js" type="text/javascript"></script>
</body>
</html>